# Main application secrets
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "alert-history.fullname" . }}-secrets
  namespace: {{ .Values.namespace | default .Release.Namespace }}
  labels:
    {{- include "alert-history.labels" . | nindent 4 }}
    app.kubernetes.io/component: secrets
type: Opaque
data:
  # PostgreSQL credentials (if not using external secret)
  {{- if and .Values.postgresql.enabled (not .Values.postgresql.existingSecret) }}
  {{- $postgresPassword := .Values.postgresql.password | default (randAlphaNum 32) }}
  postgres-password: {{ $postgresPassword | b64enc }}
  {{- if .Values.postgresql.username }}
  postgres-username: {{ .Values.postgresql.username | b64enc }}
  username: {{ .Values.postgresql.username | b64enc }}
  {{- end }}
  {{- if .Values.postgresql.database }}
  postgres-database: {{ .Values.postgresql.database | b64enc }}
  {{- end }}
  # CloudNativePG required keys
  password: {{ $postgresPassword | b64enc }}
  {{- end }}

  # Valkey/Redis credentials (if authentication enabled)
  {{- if and .Values.cache.enabled .Values.cache.auth.enabled }}
  {{- $redisPassword := .Values.cache.auth.password | default (randAlphaNum 32) }}
  redis-password: {{ $redisPassword | b64enc }}
  {{- end }}

  # LLM API credentials
  {{- if .Values.llm.enabled }}
  {{- if .Values.llm.apiKey }}
  llm-api-key: {{ .Values.llm.apiKey | b64enc }}
  {{- end }}
  {{- if .Values.llm.authToken }}
  llm-auth-token: {{ .Values.llm.authToken | b64enc }}
  {{- end }}
  {{- end }}

  # Application secrets
  {{- if .Values.secrets.jwtSecret }}
  jwt-secret: {{ .Values.secrets.jwtSecret | b64enc }}
  {{- end }}
  {{- if .Values.secrets.encryptionKey }}
  encryption-key: {{ .Values.secrets.encryptionKey | b64enc }}
  {{- end }}
---
{{- if .Values.publishingTargets }}
{{- range $target := .Values.publishingTargets }}
{{- if $target.secret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "alert-history.fullname" $ }}-{{ $target.name }}-target
  namespace: {{ $.Values.namespace | default $.Release.Namespace }}
  labels:
    {{- include "alert-history.labels" $ | nindent 4 }}
    app.kubernetes.io/component: publishing-target
    # Labels for dynamic discovery (used by DynamicTargetManager)
    alert-history.io/target: "true"
    alert-history.io/target-name: {{ $target.name | quote }}
    alert-history.io/target-type: {{ $target.type | quote }}
    alert-history.io/target-format: {{ $target.format | quote }}
    alert-history.io/managed-by: helm
type: Opaque
data:
  target-name: {{ $target.name | b64enc }}
  webhook-url: {{ $target.url | b64enc }}
  format: {{ $target.format | b64enc }}
  enabled: {{ $target.enabled | default true | toString | b64enc }}

  {{- if $target.secret.apiKey }}
  api-key: {{ $target.secret.apiKey | b64enc }}
  {{- end }}

  {{- if $target.secret.token }}
  token: {{ $target.secret.token | b64enc }}
  {{- end }}

  {{- if $target.secret.authHeader }}
  auth-header: {{ $target.secret.authHeader | b64enc }}
  {{- end }}

  {{- if $target.secret.customHeaders }}
  {{- range $key, $value := $target.secret.customHeaders }}
  header-{{ $key }}: {{ $value | b64enc }}
  {{- end }}
  {{- end }}

  {{- if $target.filterConfig }}
  {{- if $target.filterConfig.severity }}
  filter-severity: {{ join "," $target.filterConfig.severity | b64enc }}
  {{- end }}
  {{- if $target.filterConfig.namespaces }}
  filter-namespaces: {{ join "," $target.filterConfig.namespaces | b64enc }}
  {{- end }}
  {{- if $target.filterConfig.excludeNoise }}
  exclude-noise: {{ $target.filterConfig.excludeNoise | toString | b64enc }}
  {{- end }}
  {{- if $target.filterConfig.minConfidence }}
  min-confidence: {{ $target.filterConfig.minConfidence | toString | b64enc }}
  {{- end }}
  {{- if $target.filterConfig.alertNamePattern }}
  alert-name-pattern: {{ $target.filterConfig.alertNamePattern | b64enc }}
  {{- end }}
  {{- end }}
---
{{- end }}
{{- end }}
{{- end }}
