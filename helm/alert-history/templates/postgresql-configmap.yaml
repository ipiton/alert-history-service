{{- if and (eq .Values.profile "standard") .Values.postgresql.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "alert-history.postgresql.fullname" . }}-config
  namespace: {{ .Values.namespace | default .Release.Namespace }}
  labels:
    {{- include "alert-history.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
  annotations:
    description: "PostgreSQL configuration optimized for HPA cluster mode (2-10 replicas)"
    managed-by: Helm
    helm.sh/resource-policy: keep
data:
  postgresql.conf: |
    # =============================================================================
    # PostgreSQL Configuration for Alert History - HPA Cluster Mode
    # =============================================================================
    # Optimized for: 2-10 application replicas with HPA autoscaling
    # Connection calculation: 10 replicas × 20 conns/pod = 200 connections
    # Reserved: 50 connections (monitoring, admin, other services)
    # Total: 250 max_connections
    # =============================================================================

    # -----------------------------------------------------------------------------
    # Connection Settings
    # -----------------------------------------------------------------------------
    max_connections = {{ .Values.postgresql.config.maxConnections | default 250 }}
    # Default: 100 (too low for cluster mode)
    # Recommended: 250 for 10 replicas × 20 conns + 50 reserved
    # Formula: (replicas × conns_per_pod) + reserved_connections
    # At 10 replicas: 10 × 20 + 50 = 250

    superuser_reserved_connections = {{ .Values.postgresql.config.superuserReservedConnections | default 10 }}
    # Reserved for superuser maintenance tasks

    # -----------------------------------------------------------------------------
    # Memory Settings (tuned for max_connections = 250)
    # -----------------------------------------------------------------------------
    shared_buffers = {{ .Values.postgresql.config.sharedBuffers | default "256MB" }}
    # Rule: ~25% of available memory or 256MB per 100 connections
    # For max_connections=250: 256MB is optimal
    # Higher values may cause memory pressure on small instances

    effective_cache_size = {{ .Values.postgresql.config.effectiveCacheSize | default "1GB" }}
    # Rule: ~50-75% of total system memory
    # Helps query planner make better decisions

    work_mem = {{ .Values.postgresql.config.workMem | default "4MB" }}
    # Per-operation memory (sort, hash)
    # Rule: (Total RAM - shared_buffers) / (max_connections × 3)
    # For 2GB RAM, 250 conns: (2GB - 256MB) / (250 × 3) ≈ 2-4MB

    maintenance_work_mem = {{ .Values.postgresql.config.maintenanceWorkMem | default "64MB" }}
    # For VACUUM, CREATE INDEX, etc.
    # Rule: Total RAM / 16, max 2GB

    # -----------------------------------------------------------------------------
    # Write-Ahead Log (WAL) Settings
    # -----------------------------------------------------------------------------
    wal_buffers = {{ .Values.postgresql.config.walBuffers | default "16MB" }}
    # Default: -1 (auto, 1/32 of shared_buffers)
    # Explicit 16MB for better write performance

    max_wal_size = {{ .Values.postgresql.config.maxWalSize | default "1GB" }}
    min_wal_size = {{ .Values.postgresql.config.minWalSize | default "80MB" }}
    # Controls checkpoint frequency
    # Larger = less frequent checkpoints = better performance

    checkpoint_completion_target = {{ .Values.postgresql.config.checkpointCompletionTarget | default 0.9 }}
    # Spread checkpoint I/O over 90% of checkpoint interval

    # -----------------------------------------------------------------------------
    # Query Planning
    # -----------------------------------------------------------------------------
    random_page_cost = {{ .Values.postgresql.config.randomPageCost | default 1.1 }}
    # Default: 4.0 (for HDD)
    # SSD-optimized: 1.1 (encourages index usage)

    effective_io_concurrency = {{ .Values.postgresql.config.effectiveIoConcurrency | default 200 }}
    # Default: 1 (for HDD)
    # SSD-optimized: 200 (parallel I/O operations)

    # -----------------------------------------------------------------------------
    # Connection Pooling (Application-Side: pgx)
    # -----------------------------------------------------------------------------
    # Note: These settings are complementary to application connection pool
    # Application (pgx) configuration:
    #   MaxConns: 20 per pod (configurable via DB_MAX_CONNS)
    #   MinConns: 2 per pod (configurable via DB_MIN_CONNS)
    #   MaxConnLifetime: 1h
    #   MaxConnIdleTime: 5min
    #
    # At 10 replicas: 10 × 20 = 200 active connections (80% of max_connections)

    # -----------------------------------------------------------------------------
    # Performance Monitoring
    # -----------------------------------------------------------------------------
    shared_preload_libraries = '{{ .Values.postgresql.config.sharedPreloadLibraries | default "pg_stat_statements" }}'
    # Enable query statistics tracking

    track_activities = {{ .Values.postgresql.config.trackActivities | default "on" }}
    track_counts = {{ .Values.postgresql.config.trackCounts | default "on" }}
    track_io_timing = {{ .Values.postgresql.config.trackIoTiming | default "on" }}
    # Enable performance metrics collection

    # -----------------------------------------------------------------------------
    # Logging (for debugging connection issues)
    # -----------------------------------------------------------------------------
    log_connections = {{ .Values.postgresql.config.logConnections | default "off" }}
    # Enable to debug connection pool issues (disable in production for performance)

    log_disconnections = {{ .Values.postgresql.config.logDisconnections | default "off" }}
    # Enable to track connection lifecycle

    log_line_prefix = '{{ .Values.postgresql.config.logLinePrefix | default "%m [%p] %u@%d " }}'
    # Log format: timestamp [pid] user@database

    log_min_duration_statement = {{ .Values.postgresql.config.logMinDurationStatement | default 1000 }}
    # Log queries slower than 1000ms (1 second)

    # -----------------------------------------------------------------------------
    # Autovacuum (critical for high-write workloads)
    # -----------------------------------------------------------------------------
    autovacuum = {{ .Values.postgresql.config.autovacuum | default "on" }}
    autovacuum_max_workers = {{ .Values.postgresql.config.autovacuumMaxWorkers | default 3 }}
    autovacuum_naptime = {{ .Values.postgresql.config.autovacuumNaptime | default "1min" }}
    # More frequent autovacuum for high-write alert ingestion

    # -----------------------------------------------------------------------------
    # Security
    # -----------------------------------------------------------------------------
    ssl = {{ .Values.postgresql.config.ssl | default "off" }}
    # Enable SSL/TLS (requires certificates)
    # Set to 'on' in production with proper cert management

    # =============================================================================
    # End of PostgreSQL Configuration
    # =============================================================================
{{- end }}
