# Rootly-specific secrets template
{{- if .Values.rootly.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "alert-history.fullname" . }}-rootly-target
  namespace: {{ .Values.namespace | default .Release.Namespace }}
  labels:
    {{- include "alert-history.labels" . | nindent 4 }}
    app.kubernetes.io/component: publishing-target
    # Critical labels for dynamic discovery
    alert-history.io/target: "true"
    alert-history.io/target-name: "rootly-production"
    alert-history.io/target-type: "webhook"
    alert-history.io/target-format: "rootly"
    alert-history.io/priority: "high"
    alert-history.io/managed-by: helm
  annotations:
    description: "Rootly incident management integration"
type: Opaque
data:
  # Target identification
  target-name: {{ "rootly-production" | b64enc }}
  target-type: {{ "webhook" | b64enc }}
  format: {{ "rootly" | b64enc }}
  enabled: {{ .Values.rootly.enabled | toString | b64enc }}

  # Rootly webhook configuration
  webhook-url: {{ .Values.rootly.webhookUrl | b64enc }}

  # Rootly API credentials
  {{- if .Values.rootly.apiKey }}
  api-key: {{ .Values.rootly.apiKey | b64enc }}
  {{- end }}

  {{- if .Values.rootly.authToken }}
  auth-token: {{ .Values.rootly.authToken | b64enc }}
  {{- end }}

  # Rootly-specific headers
  {{- if .Values.rootly.orgId }}
  org-id: {{ .Values.rootly.orgId | b64enc }}
  {{- end }}

  # Custom headers for Rootly API
  header-Content-Type: {{ "application/json" | b64enc }}
  header-User-Agent: {{ printf "alert-history-service/%s" .Chart.AppVersion | b64enc }}
  {{- if .Values.rootly.customHeaders }}
  {{- range $key, $value := .Values.rootly.customHeaders }}
  header-{{ $key }}: {{ $value | b64enc }}
  {{- end }}
  {{- end }}

  # Rootly filtering configuration
  {{- if .Values.rootly.filterConfig }}
  {{- if .Values.rootly.filterConfig.severity }}
  filter-severity: {{ join "," .Values.rootly.filterConfig.severity | b64enc }}
  {{- end }}
  {{- if .Values.rootly.filterConfig.namespaces }}
  filter-namespaces: {{ join "," .Values.rootly.filterConfig.namespaces | b64enc }}
  {{- end }}
  {{- if .Values.rootly.filterConfig.excludeNoise }}
  exclude-noise: {{ .Values.rootly.filterConfig.excludeNoise | toString | b64enc }}
  {{- end }}
  {{- if .Values.rootly.filterConfig.minConfidence }}
  min-confidence: {{ .Values.rootly.filterConfig.minConfidence | toString | b64enc }}
  {{- end }}
  {{- if .Values.rootly.filterConfig.alertNamePattern }}
  alert-name-pattern: {{ .Values.rootly.filterConfig.alertNamePattern | b64enc }}
  {{- end }}
  {{- if .Values.rootly.filterConfig.incidentTypes }}
  incident-types: {{ join "," .Values.rootly.filterConfig.incidentTypes | b64enc }}
  {{- end }}
  {{- if .Values.rootly.filterConfig.services }}
  target-services: {{ join "," .Values.rootly.filterConfig.services | b64enc }}
  {{- end }}
  {{- if .Values.rootly.filterConfig.environments }}
  target-environments: {{ join "," .Values.rootly.filterConfig.environments | b64enc }}
  {{- end }}
  {{- end }}

  # Rootly incident management settings
  {{- if .Values.rootly.incidentSettings }}
  {{- if .Values.rootly.incidentSettings.autoCreate }}
  auto-create-incident: {{ .Values.rootly.incidentSettings.autoCreate | toString | b64enc }}
  {{- end }}
  {{- if .Values.rootly.incidentSettings.severity }}
  default-incident-severity: {{ .Values.rootly.incidentSettings.severity | b64enc }}
  {{- end }}
  {{- if .Values.rootly.incidentSettings.assignTeam }}
  assign-team: {{ .Values.rootly.incidentSettings.assignTeam | b64enc }}
  {{- end }}
  {{- if .Values.rootly.incidentSettings.tags }}
  incident-tags: {{ join "," .Values.rootly.incidentSettings.tags | b64enc }}
  {{- end }}
  {{- end }}

{{- end }}
