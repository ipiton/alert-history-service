groups:
  - name: proxy_webhook
    interval: 30s
    rules:
      # Critical Alerts (P0)
      - alert: ProxyWebhookHighErrorRate
        expr: |
          rate(alert_history_proxy_http_errors_total[5m]) > 10
        for: 5m
        labels:
          severity: critical
          service: alert-history
          component: proxy-webhook
          priority: P0
        annotations:
          summary: "High error rate on proxy webhook endpoint"
          description: |
            The proxy webhook endpoint is experiencing a high error rate.
            Current error rate: {{ $value | humanize }} errors/second (threshold: 10)
            Check logs for error details and investigate root cause.
          runbook_url: https://docs.alerthistory.io/runbooks/high-error-rate
          dashboard_url: https://grafana.company.com/d/proxy-webhook

      - alert: ProxyWebhookHighLatency
        expr: |
          histogram_quantile(0.95, 
            rate(alert_history_proxy_http_request_duration_seconds_bucket[5m])
          ) > 1.0
        for: 5m
        labels:
          severity: critical
          service: alert-history
          component: proxy-webhook
          priority: P0
        annotations:
          summary: "High p95 latency on proxy webhook endpoint"
          description: |
            The proxy webhook endpoint p95 latency is above threshold.
            Current p95 latency: {{ $value | humanizeDuration }} (threshold: 1s)
            This may impact user experience. Check for LLM or publishing delays.
          runbook_url: https://docs.alerthistory.io/runbooks/high-latency
          dashboard_url: https://grafana.company.com/d/proxy-webhook

      # Warning Alerts (P1)
      - alert: ProxyWebhookClassificationSlow
        expr: |
          histogram_quantile(0.95,
            rate(alert_history_proxy_classification_duration_seconds_bucket[5m])
          ) > 5.0
        for: 10m
        labels:
          severity: warning
          service: alert-history
          component: proxy-webhook
          priority: P1
        annotations:
          summary: "LLM classification is slow on proxy webhook"
          description: |
            The LLM classification pipeline is experiencing slow response times.
            Current p95 classification time: {{ $value | humanizeDuration }} (threshold: 5s)
            Check LLM service health and cache hit rate.
          runbook_url: https://docs.alerthistory.io/runbooks/slow-classification
          dashboard_url: https://grafana.company.com/d/proxy-webhook

      - alert: ProxyWebhookPublishingFailures
        expr: |
          rate(alert_history_proxy_publishing_errors_total[5m]) > 1
        for: 10m
        labels:
          severity: warning
          service: alert-history
          component: proxy-webhook
          priority: P1
        annotations:
          summary: "Publishing failures detected on proxy webhook"
          description: |
            The proxy webhook is experiencing publishing failures.
            Current publishing error rate: {{ $value | humanize }} errors/second (threshold: 1)
            Check target health (Rootly, PagerDuty, Slack) and network connectivity.
          runbook_url: https://docs.alerthistory.io/runbooks/publishing-failures
          dashboard_url: https://grafana.company.com/d/proxy-webhook

      - alert: ProxyWebhookLowSuccessRate
        expr: |
          (
            rate(alert_history_proxy_alerts_processed_total{result="success"}[5m]) 
            / 
            rate(alert_history_proxy_alerts_processed_total[5m])
          ) < 0.95
        for: 15m
        labels:
          severity: warning
          service: alert-history
          component: proxy-webhook
          priority: P1
        annotations:
          summary: "Low success rate on proxy webhook endpoint"
          description: |
            The proxy webhook endpoint success rate is below threshold.
            Current success rate: {{ $value | humanizePercentage }} (threshold: 95%)
            Check for classification, filtering, or publishing issues.
          runbook_url: https://docs.alerthistory.io/runbooks/low-success-rate
          dashboard_url: https://grafana.company.com/d/proxy-webhook

      # Info Alerts (P2)
      - alert: ProxyWebhookHighConcurrency
        expr: |
          alert_history_proxy_http_requests_in_flight > 50
        for: 5m
        labels:
          severity: info
          service: alert-history
          component: proxy-webhook
          priority: P2
        annotations:
          summary: "High concurrency on proxy webhook endpoint"
          description: |
            The proxy webhook endpoint is processing a high number of concurrent requests.
            Current concurrent requests: {{ $value }} (threshold: 50)
            Monitor for potential resource constraints. Consider scaling if sustained.
          dashboard_url: https://grafana.company.com/d/proxy-webhook

