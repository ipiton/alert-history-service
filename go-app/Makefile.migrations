# Makefile –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make -f Makefile.migrations <target>

.PHONY: help migrate-up migrate-down migrate-status migrate-version migrate-create migrate-redo migrate-reset migrate-validate migrate-fix backup-create backup-list backup-cleanup health-check migrate-dry-run migrate-up-to migrate-down-by

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
MIGRATION_BINARY ?= ./bin/migrate
MIGRATION_DRIVER ?= postgres
MIGRATION_DSN ?= postgres://user:password@localhost:5432/alert_history?sslmode=disable
MIGRATION_DIR ?= ./migrations
MIGRATION_TABLE ?= goose_db_version

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m # No Color

# –ü–æ–º–æ—â—å
help:
	@echo "$(BLUE)üê¶ Goose Migration Management$(NC)"
	@echo ""
	@echo "$(YELLOW)Migration Commands:$(NC)"
	@echo "  $(GREEN)make migrate-up$(NC)           - Apply all pending migrations"
	@echo "  $(GREEN)make migrate-down$(NC)         - Rollback all migrations"
	@echo "  $(GREEN)make migrate-status$(NC)       - Show migration status"
	@echo "  $(GREEN)make migrate-version$(NC)      - Show current migration version"
	@echo "  $(GREEN)make migrate-create name=<name>$(NC) - Create new migration file"
	@echo "  $(GREEN)make migrate-redo$(NC)          - Redo the last migration"
	@echo "  $(GREEN)make migrate-reset$(NC)         - Reset all migrations (WARNING: DATA LOSS)"
	@echo "  $(GREEN)make migrate-validate$(NC)      - Validate migration files"
	@echo "  $(GREEN)make migrate-fix$(NC)           - Fix common migration issues"
	@echo "  $(GREEN)make migrate-dry-run$(NC)       - Show what would be migrated (dry run)"
	@echo ""
	@echo "$(YELLOW)Backup Commands:$(NC)"
	@echo "  $(GREEN)make backup-create$(NC)         - Create database backup"
	@echo "  $(GREEN)make backup-list$(NC)           - List backup files"
	@echo "  $(GREEN)make backup-cleanup$(NC)        - Clean up old backup files"
	@echo ""
	@echo "$(YELLOW)Health Check:$(NC)"
	@echo "  $(GREEN)make health-check$(NC)          - Run database health checks"
	@echo ""
	@echo "$(YELLOW)Configuration:$(NC)"
	@echo "  Current settings:"
	@echo "    DRIVER: $(MIGRATION_DRIVER)"
	@echo "    DSN: $(MIGRATION_DSN)"
	@echo "    DIR: $(MIGRATION_DIR)"
	@echo "    TABLE: $(MIGRATION_TABLE)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check-dependencies:
	@echo "$(BLUE)üîç Checking dependencies...$(NC)"
	@command -v goose >/dev/null 2>&1 || { echo "$(RED)‚ùå goose is not installed. Install with: go install github.com/pressly/goose/v3/cmd/goose@latest$(NC)" >&2; exit 1; }
	@echo "$(GREEN)‚úÖ Dependencies OK$(NC)"

# –°–æ–∑–¥–∞–Ω–∏–µ –±–∏–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –º–∏–≥—Ä–∞—Ç–æ—Ä–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
build-migration-tool:
	@echo "$(BLUE)üî® Building migration tool...$(NC)"
	@mkdir -p bin
	@go build -o $(MIGRATION_BINARY) ./cmd/migrate
	@echo "$(GREEN)‚úÖ Migration tool built: $(MIGRATION_BINARY)$(NC)"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
migrate-up: check-dependencies
	@echo "$(BLUE)üöÄ Applying migrations...$(NC)"
	@goose -dir $(MIGRATION_DIR) $(MIGRATION_DRIVER) "$(MIGRATION_DSN)" up
	@echo "$(GREEN)‚úÖ All migrations applied successfully$(NC)"

# –û—Ç–∫–∞—Ç –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π
migrate-down: check-dependencies
	@echo "$(YELLOW)‚ö†Ô∏è  WARNING: This will rollback ALL migrations!$(NC)"
	@read -p "Are you sure? (yes/no): " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		echo "$(BLUE)üîÑ Rolling back all migrations...$(NC)"; \
		goose -dir $(MIGRATION_DIR) $(MIGRATION_DRIVER) "$(MIGRATION_DSN)" down; \
		echo "$(GREEN)‚úÖ All migrations rolled back$(NC)"; \
	else \
		echo "$(YELLOW)Operation cancelled$(NC)"; \
	fi

# –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π
migrate-status: check-dependencies
	@echo "$(BLUE)üìä Migration Status:$(NC)"
	@echo "=================================================="
	@goose -dir $(MIGRATION_DIR) $(MIGRATION_DRIVER) "$(MIGRATION_DSN)" status

# –í–µ—Ä—Å–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
migrate-version: check-dependencies
	@echo "$(BLUE)üìã Current Migration Version:$(NC)"
	@version=$$(goose -dir $(MIGRATION_DIR) $(MIGRATION_DRIVER) "$(MIGRATION_DSN)" version 2>/dev/null); \
	if [ $$? -eq 0 ]; then \
		echo "$(GREEN)$$version$(NC)"; \
	else \
		echo "$(YELLOW)No migrations applied yet$(NC)"; \
	fi

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
migrate-create: check-dependencies
	@if [ -z "$(name)" ]; then \
		echo "$(RED)‚ùå Error: Migration name is required$(NC)"; \
		echo "Usage: make migrate-create name=<migration_name>"; \
		exit 1; \
	fi
	@echo "$(BLUE)‚ú® Creating new migration: $(name)$(NC)"
	@goose -dir $(MIGRATION_DIR) $(MIGRATION_DRIVER) "$(MIGRATION_DSN)" create $(name) sql
	@echo "$(GREEN)‚úÖ Migration created successfully$(NC)"

# –ü–µ—Ä–µ–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏
migrate-redo: check-dependencies
	@echo "$(BLUE)üîÑ Redoing last migration...$(NC)"
	@goose -dir $(MIGRATION_DIR) $(MIGRATION_DRIVER) "$(MIGRATION_DSN)" down
	@goose -dir $(MIGRATION_DIR) $(MIGRATION_DRIVER) "$(MIGRATION_DSN)" up
	@echo "$(GREEN)‚úÖ Last migration redone successfully$(NC)"

# –°–±—Ä–æ—Å –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π
migrate-reset: check-dependencies
	@echo "$(RED)üö® DANGER ZONE: This will RESET ALL MIGRATIONS!$(NC)"
	@echo "$(RED)üö® ALL DATA WILL BE LOST!$(NC)"
	@read -p "Type 'YES' to confirm: " confirm; \
	if [ "$$confirm" = "YES" ]; then \
		echo "$(BLUE)üî• Resetting all migrations...$(NC)"; \
		goose -dir $(MIGRATION_DIR) $(MIGRATION_DRIVER) "$(MIGRATION_DSN)" reset; \
		echo "$(GREEN)‚úÖ All migrations reset$(NC)"; \
	else \
		echo "$(YELLOW)Operation cancelled$(NC)"; \
	fi

# –í–∞–ª–∏–¥–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
migrate-validate: check-dependencies
	@echo "$(BLUE)üîç Validating migrations...$(NC)"
	@# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π
	@if [ ! -d "$(MIGRATION_DIR)" ]; then \
		echo "$(RED)‚ùå Migration directory does not exist: $(MIGRATION_DIR)$(NC)"; \
		exit 1; \
	fi
	@# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π
	@migration_count=$$(ls -1 $(MIGRATION_DIR)/*.sql 2>/dev/null | wc -l); \
	if [ $$migration_count -eq 0 ]; then \
		echo "$(YELLOW)‚ö†Ô∏è  No migration files found$(NC)"; \
	else \
		echo "$(GREEN)‚úÖ Found $$migration_count migration file(s)$(NC)"; \
	fi
	@# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —Ñ–∞–π–ª–æ–≤
	@echo "$(BLUE)üîç Checking migration file syntax...$(NC)"
	@for file in $(MIGRATION_DIR)/*.sql; do \
		if [ -f "$$file" ]; then \
			if head -1 "$$file" | grep -q "^-- +goose Up"; then \
				echo "$(GREEN)‚úÖ $$file - syntax OK$(NC)"; \
			else \
				echo "$(RED)‚ùå $$file - invalid goose header$(NC)"; \
			fi; \
		fi; \
	done
	@echo "$(GREEN)‚úÖ Migration validation completed$(NC)"

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
migrate-fix: check-dependencies
	@echo "$(BLUE)üîß Fixing migration issues...$(NC)"
	@# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
	@if [ ! -d "$(MIGRATION_DIR)" ]; then \
		echo "$(YELLOW)üìÅ Creating migration directory...$(NC)"; \
		mkdir -p $(MIGRATION_DIR); \
	fi
	@# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é —Ñ–∞–π–ª–æ–≤
	@ls -1 $(MIGRATION_DIR)/*.sql 2>/dev/null | sort -V
	@echo "$(GREEN)‚úÖ Migration fix completed$(NC)"

# Dry run –º–∏–≥—Ä–∞—Ü–∏–π
migrate-dry-run: check-dependencies
	@echo "$(BLUE)üîç Migration Dry Run:$(NC)"
	@echo "=================================================="
	@echo "$(YELLOW)This will show what migrations would be applied:$(NC)"
	@goose -dir $(MIGRATION_DIR) $(MIGRATION_DRIVER) "$(MIGRATION_DSN)" status | grep "Pending"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –¥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏
migrate-up-to: check-dependencies
	@if [ -z "$(version)" ]; then \
		echo "$(RED)‚ùå Error: Version number is required$(NC)"; \
		echo "Usage: make migrate-up-to version=<number>"; \
		exit 1; \
	fi
	@echo "$(BLUE)üöÄ Applying migrations up to version $(version)...$(NC)"
	@goose -dir $(MIGRATION_DIR) $(MIGRATION_DRIVER) "$(MIGRATION_DSN)" up-to $(version)
	@echo "$(GREEN)‚úÖ Migrations applied up to version $(version)$(NC)"

# –û—Ç–∫–∞—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–∏–≥—Ä–∞—Ü–∏–π
migrate-down-by: check-dependencies
	@if [ -z "$(steps)" ]; then \
		echo "$(RED)‚ùå Error: Number of steps is required$(NC)"; \
		echo "Usage: make migrate-down-by steps=<number>"; \
		exit 1; \
	fi
	@echo "$(BLUE)üîÑ Rolling back $(steps) migration(s)...$(NC)"
	@for i in $$(seq 1 $(steps)); do \
		echo "Rolling back step $$i..."; \
		goose -dir $(MIGRATION_DIR) $(MIGRATION_DRIVER) "$(MIGRATION_DSN)" down; \
	done
	@echo "$(GREEN)‚úÖ Rolled back $(steps) migration(s)$(NC)"

# –°–æ–∑–¥–∞–Ω–∏–µ backup
backup-create: check-dependencies
	@echo "$(BLUE)üíæ Creating database backup...$(NC)"
	@timestamp=$$(date +%Y%m%d_%H%M%S); \
	backup_file="./backups/backup_$${timestamp}.sql"; \
	mkdir -p ./backups; \
	case "$(MIGRATION_DRIVER)" in \
		"postgres") \
			pg_dump --schema-only --no-owner --no-privileges --file="$${backup_file}" "$(MIGRATION_DSN)" 2>/dev/null || { \
				echo "$(RED)‚ùå pg_dump failed. Make sure PostgreSQL client tools are installed$(NC)"; \
				exit 1; \
			}; \
			;; \
		"sqlite") \
			sqlite3 "$(MIGRATION_DSN)" ".dump > $${backup_file}"; \
			;; \
		*) \
			echo "$(RED)‚ùå Unsupported database driver for backup: $(MIGRATION_DRIVER)$(NC)"; \
			exit 1; \
			;; \
	esac; \
	echo "$(GREEN)‚úÖ Backup created: $${backup_file}$(NC)"

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ backup —Ñ–∞–π–ª–æ–≤
backup-list: check-dependencies
	@echo "$(BLUE)üìã Backup Files:$(NC)"
	@echo "=================================================="
	@if [ -d "./backups" ]; then \
		ls -la ./backups/ | grep -E "\.(sql|dump|bak)$$" | head -10; \
		echo ""; \
		echo "$(YELLOW)Total backup files: $$(ls -1 ./backups/ | grep -E "\.(sql|dump|bak)$$" | wc -l)$(NC)"; \
	else \
		echo "$(YELLOW)No backup directory found$(NC)"; \
	fi

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö backup —Ñ–∞–π–ª–æ–≤
backup-cleanup: check-dependencies
	@echo "$(BLUE)üßπ Cleaning up old backup files...$(NC)"
	@retention_days=30; \
	if [ -d "./backups" ]; then \
		find ./backups/ -name "*.sql" -mtime +$$retention_days -delete 2>/dev/null; \
		find ./backups/ -name "*.dump" -mtime +$$retention_days -delete 2>/dev/null; \
		find ./backups/ -name "*.bak" -mtime +$$retention_days -delete 2>/dev/null; \
		echo "$(GREEN)‚úÖ Old backup files cleaned up (older than $$retention_days days)$(NC)"; \
	else \
		echo "$(YELLOW)No backup directory found$(NC)"; \
	fi

# Health check –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
health-check: check-dependencies
	@echo "$(BLUE)üè• Running database health checks...$(NC)"
	@case "$(MIGRATION_DRIVER)" in \
		"postgres") \
			echo "$(YELLOW)Checking PostgreSQL connection...$(NC)"; \
			psql "$(MIGRATION_DSN)" -c "SELECT version();" >/dev/null 2>&1 && echo "$(GREEN)‚úÖ PostgreSQL connection OK$(NC)" || echo "$(RED)‚ùå PostgreSQL connection failed$(NC)"; \
			;; \
		"sqlite") \
			echo "$(YELLOW)Checking SQLite database...$(NC)"; \
			sqlite3 "$(MIGRATION_DSN)" "SELECT sqlite_version();" >/dev/null 2>&1 && echo "$(GREEN)‚úÖ SQLite database OK$(NC)" || echo "$(RED)‚ùå SQLite database check failed$(NC)"; \
			;; \
		*) \
			echo "$(RED)‚ùå Unsupported database driver for health check: $(MIGRATION_DRIVER)$(NC)"; \
			exit 1; \
			;; \
	esac
	@echo "$(GREEN)‚úÖ Health check completed$(NC)"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ goose (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
install-goose:
	@echo "$(BLUE)üì¶ Installing goose...$(NC)"
	@go install github.com/pressly/goose/v3/cmd/goose@latest
	@echo "$(GREEN)‚úÖ Goose installed$(NC)"

# –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
db-info: check-dependencies
	@echo "$(BLUE)‚ÑπÔ∏è  Database Information:$(NC)"
	@echo "=================================================="
	@echo "Driver: $(MIGRATION_DRIVER)"
	@echo "DSN: $(MIGRATION_DSN)"
	@echo "Migration Directory: $(MIGRATION_DIR)"
	@echo "Migration Table: $(MIGRATION_TABLE)"
	@echo ""
	@case "$(MIGRATION_DRIVER)" in \
		"postgres") \
			echo "$(YELLOW)PostgreSQL Info:$(NC)"; \
			psql "$(MIGRATION_DSN)" -c "SELECT version();" 2>/dev/null || echo "Could not connect to PostgreSQL"; \
			;; \
		"sqlite") \
			echo "$(YELLOW)SQLite Info:$(NC)"; \
			sqlite3 "$(MIGRATION_DSN)" "SELECT sqlite_version();" 2>/dev/null || echo "Could not access SQLite database"; \
			;; \
	esac

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
clean:
	@echo "$(BLUE)üßπ Cleaning up...$(NC)"
	@rm -rf bin/
	@echo "$(GREEN)‚úÖ Cleanup completed$(NC)"

# –ü–æ–ª–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
setup: install-goose
	@echo "$(GREEN)‚úÖ Migration system setup completed$(NC)"
	@echo ""
	@echo "$(BLUE)Next steps:$(NC)"
	@echo "  1. Configure your database connection in environment variables"
	@echo "  2. Create your first migration: make migrate-create name=initial_schema"
	@echo "  3. Apply migrations: make migrate-up"
	@echo "  4. Check status: make migrate-status"
