---
# PagerDuty Publishing Target Secret Example
# This Kubernetes Secret defines a PagerDuty Events API v2 integration for Alert History Service
#
# Usage:
#   1. Copy this file and update the routing_key with your PagerDuty integration key
#   2. Apply: kubectl apply -f pagerduty-secret-example.yaml -n alert-history
#   3. The Alert History Service will auto-discover this target via label selector

apiVersion: v1
kind: Secret
metadata:
  name: pagerduty-production
  namespace: alert-history
  labels:
    # REQUIRED: This label enables auto-discovery by Target Discovery Manager (TN-047)
    publishing-target: "true"
  annotations:
    description: "PagerDuty Events API v2 integration for production incidents"
    owner: "platform-team@example.com"
    pagerduty-service: "https://example.pagerduty.com/services/PXXXX"
type: Opaque
stringData:
  # REQUIRED: Publishing target configuration (JSON format)
  target.json: |
    {
      "name": "pagerduty-production",
      "type": "pagerduty",
      "url": "https://events.pagerduty.com",
      "format": "pagerduty",
      "enabled": true,
      "headers": {
        "routing_key": "YOUR_PAGERDUTY_INTEGRATION_KEY_HERE"
      },
      "metadata": {
        "environment": "production",
        "severity_threshold": "warning",
        "description": "Production incidents via PagerDuty Events API v2"
      }
    }

---
# Example: PagerDuty Integration for High Severity Only
apiVersion: v1
kind: Secret
metadata:
  name: pagerduty-critical-only
  namespace: alert-history
  labels:
    publishing-target: "true"
  annotations:
    description: "PagerDuty integration for critical alerts only"
type: Opaque
stringData:
  target.json: |
    {
      "name": "pagerduty-critical",
      "type": "pagerduty",
      "url": "https://events.pagerduty.com",
      "format": "pagerduty",
      "enabled": true,
      "headers": {
        "routing_key": "YOUR_CRITICAL_INTEGRATION_KEY"
      },
      "filters": {
        "severity": ["critical"]
      },
      "metadata": {
        "environment": "production",
        "severity_threshold": "critical",
        "escalation_policy": "critical-alerts-policy"
      }
    }

---
# Example: PagerDuty Integration with Custom Fields
apiVersion: v1
kind: Secret
metadata:
  name: pagerduty-platform-team
  namespace: alert-history
  labels:
    publishing-target: "true"
  annotations:
    description: "Platform team PagerDuty integration with custom fields"
    team: "platform"
type: Opaque
stringData:
  target.json: |
    {
      "name": "pagerduty-platform",
      "type": "pagerduty",
      "url": "https://events.pagerduty.com",
      "format": "pagerduty",
      "enabled": true,
      "headers": {
        "routing_key": "YOUR_PLATFORM_TEAM_KEY"
      },
      "filters": {
        "namespace": ["production", "staging"],
        "labels": {
          "team": "platform"
        }
      },
      "metadata": {
        "team": "platform",
        "slack_channel": "#platform-alerts",
        "runbook_base_url": "https://runbooks.example.com/platform"
      }
    }

---
# Example: PagerDuty Change Events Integration
# Tracks deployments and infrastructure changes
apiVersion: v1
kind: Secret
metadata:
  name: pagerduty-change-events
  namespace: alert-history
  labels:
    publishing-target: "true"
  annotations:
    description: "PagerDuty Change Events for deployment tracking"
type: Opaque
stringData:
  target.json: |
    {
      "name": "pagerduty-changes",
      "type": "pagerduty",
      "url": "https://events.pagerduty.com",
      "format": "pagerduty",
      "enabled": true,
      "headers": {
        "routing_key": "YOUR_CHANGE_EVENTS_KEY"
      },
      "filters": {
        "labels": {
          "change_event": "true"
        }
      },
      "metadata": {
        "event_type": "change",
        "description": "Deployment and infrastructure change tracking"
      }
    }

---
# Notes:
#
# 1. Routing Key:
#    - Get from PagerDuty: Services → Your Service → Integrations → Events API v2
#    - Format: 32-character alphanumeric string
#
# 2. Event Actions:
#    - trigger: Creates a new incident (alert.status = firing)
#    - resolve: Resolves existing incident (alert.status = resolved)
#    - acknowledge: Acknowledges incident (manual via API only)
#
# 3. Severity Mapping:
#    - critical → PagerDuty "critical"
#    - warning → PagerDuty "warning"
#    - info → PagerDuty "info"
#    - LLM classification severity is used when available
#
# 4. Custom Details:
#    - All alert labels/annotations are included in custom_details
#    - LLM classification data (severity, confidence, reasoning) is injected
#    - Fingerprint, namespace, cluster info included
#
# 5. Links & Images:
#    - grafana_url → Link to Grafana dashboard
#    - runbook_url → Link to runbook
#    - grafana_snapshot → Image attachment
#
# 6. Rate Limiting:
#    - PagerDuty limit: 120 req/min per integration key
#    - Client-side rate limiting: Token bucket (burst: 10)
#    - Retry logic: Exponential backoff (100ms → 5s max)
#
# 7. Dedup Key:
#    - alert.fingerprint is used as dedup_key
#    - Ensures trigger/resolve events correlate correctly
#    - Cached for 24h (TTL)
#
# 8. Metrics:
#    - pagerduty_events_published_total (trigger, resolve, change_event)
#    - pagerduty_publish_errors_total
#    - pagerduty_api_request_duration_seconds
#    - pagerduty_cache_hits_total / pagerduty_cache_misses_total
#
# 9. RBAC Requirements:
#    - ServiceAccount needs: secrets.get, secrets.list
#    - Namespace: alert-history (or target namespace)
#    - See: k8s/publishing/RBAC_GUIDE.md
#
# 10. Troubleshooting:
#     - Check logs: kubectl logs -n alert-history <pod> | grep -i pagerduty
#     - Verify routing_key: Test in PagerDuty web UI
#     - Check metrics: /metrics endpoint
#     - Cache status: GET /api/v2/publishing/targets/status
