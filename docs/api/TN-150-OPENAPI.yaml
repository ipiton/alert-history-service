openapi: 3.0.3
info:
  title: AlertHistory Configuration Management API
  description: |
    Enterprise-grade configuration management API with validation,
    diff calculation, hot reload, and automatic rollback capabilities.

    **Quality Grade**: A+ (150% EXCEPTIONAL)

    **Key Features**:
    - Multi-format support (JSON, YAML)
    - Multi-phase validation
    - Secret sanitization
    - Configuration diffing
    - Hot reload without restart
    - Atomic operations with rollback
    - Version history and audit logging
    - Distributed locking

  version: 2.0.0
  contact:
    name: API Support
    email: support@alerthistory.io
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080/api/v2
    description: Local development
  - url: https://staging.alerthistory.io/api/v2
    description: Staging environment
  - url: https://api.alerthistory.io/api/v2
    description: Production environment

tags:
  - name: Configuration
    description: Configuration management operations

security:
  - BearerAuth: []
  - ApiKeyAuth: []

paths:
  /config:
    post:
      tags:
        - Configuration
      summary: Update configuration
      description: |
        Updates application configuration with validation,
        diff calculation, and hot reload.

        **Features**:
        - JSON and YAML format support
        - Dry-run mode for validation
        - Partial updates (section filtering)
        - Automatic rollback on failure

        **Pipeline**: Validate → Diff → Apply → Reload

        **Performance**: < 10s total (typically 3-5s)

      operationId: updateConfig
      security:
        - BearerAuth: []
      parameters:
        - name: dry_run
          in: query
          description: Validate only, don't apply changes
          required: false
          schema:
            type: boolean
            default: false
        - name: section
          in: query
          description: "Update specific section (e.g. database, alertmanager)"
          required: false
          schema:
            type: string
            enum: [server, database, alertmanager, storage]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigUpdateRequest'
            example:
              database:
                max_connections: 100
                timeout: 30s
              server:
                port: 8080
          application/yaml:
            schema:
              type: string
            example: |
              database:
                max_connections: 100
                timeout: 30s
              server:
                port: 8080
      responses:
        '200':
          description: Configuration updated successfully
          headers:
            X-Config-Version:
              description: New configuration version number
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateSuccessResponse'
        '400':
          description: Bad request (invalid format or parameters)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: Configuration update in progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConflictResponse'
        '422':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        '500':
          description: Internal server error (automatic rollback triggered)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /config/rollback:
    post:
      tags:
        - Configuration
      summary: Rollback to previous version
      description: |
        Manually rollback configuration to a specific previous version.

        **Features**:
        - Target version validation
        - Full diff visualization
        - Audit logging

        **Note**: Creates a new version (doesn't restore version number)

      operationId: rollbackConfig
      security:
        - BearerAuth: []
      parameters:
        - name: version
          in: query
          description: Target version number to rollback to
          required: true
          schema:
            type: integer
            minimum: 0
          example: 40
      responses:
        '200':
          description: Rollback successful
          headers:
            X-Config-Version:
              description: New configuration version number after rollback
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RollbackSuccessResponse'
        '400':
          description: Invalid version parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Version not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Target version is no longer valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Rollback failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /config/history:
    get:
      tags:
        - Configuration
      summary: Get configuration version history
      description: |
        Retrieve configuration version history with metadata.

        **Features**:
        - Pagination support
        - Full version metadata
        - Secret sanitization

      operationId: getConfigHistory
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          description: Maximum number of versions to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
      responses:
        '200':
          description: History retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoryResponse'
        '400':
          description: Invalid limit parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token authentication
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key authentication

  responses:
    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            status: error
            message: Unauthorized
    Forbidden:
      description: Not admin user
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            status: error
            message: Admin access required

  schemas:
    ConfigUpdateRequest:
      type: object
      description: Configuration update request (flexible structure)
      additionalProperties: true
      example:
        database:
          host: localhost
          port: 5432
          max_connections: 100
        server:
          port: 8080
          host: 0.0.0.0

    UpdateSuccessResponse:
      type: object
      required:
        - status
        - message
        - version
        - applied_at
      properties:
        status:
          type: string
          enum: [success, dry_run]
          example: success
        message:
          type: string
          example: Configuration updated successfully (version 42)
        version:
          type: integer
          format: int64
          example: 42
        applied_at:
          type: string
          format: date-time
          example: 2025-11-22T15:30:45Z
        diff:
          $ref: '#/components/schemas/ConfigDiff'

    RollbackSuccessResponse:
      type: object
      required:
        - status
        - message
        - target_version
        - new_version
      properties:
        status:
          type: string
          enum: [success]
          example: success
        message:
          type: string
          example: "Successfully rolled back to version 40 (new version: 43)"
        target_version:
          type: integer
          format: int64
          example: 40
        new_version:
          type: integer
          format: int64
          example: 43
        diff:
          $ref: '#/components/schemas/ConfigDiff'

    HistoryResponse:
      type: object
      required:
        - status
        - count
        - versions
      properties:
        status:
          type: string
          enum: [success]
          example: success
        count:
          type: integer
          example: 10
        versions:
          type: array
          items:
            $ref: '#/components/schemas/ConfigVersion'

    ConfigVersion:
      type: object
      required:
        - version
        - created_at
        - created_by
        - source
      properties:
        version:
          type: integer
          format: int64
          example: 42
        created_at:
          type: string
          format: date-time
          example: 2025-11-22T15:30:45Z
        created_by:
          type: string
          example: admin@example.com
        source:
          type: string
          enum: [api, file, env, cli]
          example: api
        comment:
          type: string
          example: Increased database connections
        config_hash:
          type: string
          example: sha256:abc123...
        changes_summary:
          type: object
          properties:
            added:
              type: integer
              example: 1
            modified:
              type: integer
              example: 2
            deleted:
              type: integer
              example: 0

    ConfigDiff:
      type: object
      properties:
        added:
          type: object
          additionalProperties: true
          example:
            server.read_timeout: 30s
        modified:
          type: object
          additionalProperties:
            type: object
            properties:
              old:
                description: Old value
              new:
                description: New value
          example:
            database.max_connections:
              old: 50
              new: 100
        deleted:
          type: object
          additionalProperties: true
          example:
            obsolete_field: old_value
        affected_components:
          type: array
          items:
            type: string
          example: [server, database]
        has_critical_changes:
          type: boolean
          example: false

    ValidationErrorResponse:
      type: object
      required:
        - status
        - message
        - errors
      properties:
        status:
          type: string
          enum: [error]
          example: error
        message:
          type: string
          example: Configuration validation failed
        errors:
          type: array
          items:
            $ref: '#/components/schemas/ValidationError'

    ValidationError:
      type: object
      required:
        - field
        - error
        - phase
      properties:
        field:
          type: string
          example: database.port
        error:
          type: string
          example: must be between 1 and 65535
        phase:
          type: string
          enum: [syntax, schema, business, security]
          example: schema

    ConflictResponse:
      type: object
      required:
        - status
        - message
      properties:
        status:
          type: string
          enum: [error]
          example: error
        message:
          type: string
          example: Configuration update in progress by another admin
        details:
          type: object
          properties:
            locked_by:
              type: string
              example: admin@example.com
            locked_at:
              type: string
              format: date-time
              example: 2025-11-22T15:25:00Z

    ErrorResponse:
      type: object
      required:
        - status
        - message
      properties:
        status:
          type: string
          enum: [error]
          example: error
        message:
          type: string
          example: Internal server error
