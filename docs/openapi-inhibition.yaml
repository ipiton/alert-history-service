openapi: 3.0.3
info:
  title: Alert History - Inhibition API
  version: 1.0.0
  description: |
    **Alertmanager-Compatible Inhibition API**

    Provides REST API endpoints for managing and querying inhibition rules.
    Inhibition allows you to suppress (inhibit) certain alerts when other alerts are firing.

    ## Features
    - List all loaded inhibition rules
    - Query active inhibition relationships
    - Check if a specific alert would be inhibited

    ## Alertmanager Compatibility
    This API implements a subset of the Alertmanager v0.25+ inhibition API with extensions.

    ## Performance
    - All endpoints respond in <5ms p99
    - Suitable for high-throughput environments (1000+ RPS)

  contact:
    name: Alert History Team
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Development server
  - url: https://alert-history.example.com
    description: Production server

tags:
  - name: inhibition
    description: Inhibition rules and status management

paths:
  /api/v2/inhibition/rules:
    get:
      tags:
        - inhibition
      summary: List all inhibition rules
      description: |
        Returns all currently loaded inhibition rules from configuration.

        This endpoint provides read-only access to the inhibition rules
        that are actively being evaluated by the matcher engine.

        **Performance**: <2ms p99 (typical: <10µs)

        **Note**: Rules are loaded from YAML configuration at startup.
        To modify rules, update the configuration file and restart the service.

      operationId: getInhibitionRules
      responses:
        '200':
          description: Successfully retrieved inhibition rules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InhibitionRulesResponse'
              examples:
                empty:
                  summary: No rules configured
                  value:
                    rules: []
                    count: 0
                single:
                  summary: Single rule
                  value:
                    rules:
                      - name: "node-down-inhibits-instance-down"
                        source_match:
                          alertname: "NodeDown"
                          severity: "critical"
                        target_match:
                          alertname: "InstanceDown"
                        equal:
                          - node
                          - cluster
                    count: 1
                multiple:
                  summary: Multiple rules
                  value:
                    rules:
                      - name: "node-down-inhibits-instance-down"
                        source_match:
                          alertname: "NodeDown"
                        target_match:
                          alertname: "InstanceDown"
                        equal: ["node"]
                      - name: "datacenter-outage-inhibits-all"
                        source_match:
                          alertname: "DatacenterOutage"
                          severity: "critical"
                        target_match_re:
                          severity: "warning|critical"
                        equal: ["datacenter"]
                    count: 2

  /api/v2/inhibition/status:
    get:
      tags:
        - inhibition
      summary: Get active inhibition relationships
      description: |
        Returns all currently active inhibition relationships.

        An inhibition relationship exists when:
        1. A source alert is firing
        2. A target alert matches the source alert according to a rule
        3. The inhibition is recorded in the state manager

        **Performance**: <5ms p99 (typical: <40µs)

        **Use Cases**:
        - Debugging: "Why is this alert not being sent?"
        - Monitoring: Track inhibition effectiveness
        - Analytics: Understand alert relationships

      operationId: getInhibitionStatus
      responses:
        '200':
          description: Successfully retrieved active inhibitions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InhibitionStatusResponse'
              examples:
                empty:
                  summary: No active inhibitions
                  value:
                    active: []
                    count: 0
                single:
                  summary: Single active inhibition
                  value:
                    active:
                      - target_fingerprint: "abc123"
                        source_fingerprint: "def456"
                        rule_name: "node-down-inhibits-instance-down"
                        inhibited_at: "2025-11-05T10:00:00Z"
                        expires_at: "2025-11-05T10:05:00Z"
                    count: 1
                multiple:
                  summary: Multiple active inhibitions
                  value:
                    active:
                      - target_fingerprint: "fp1"
                        source_fingerprint: "src1"
                        rule_name: "rule1"
                        inhibited_at: "2025-11-05T10:00:00Z"
                      - target_fingerprint: "fp2"
                        source_fingerprint: "src2"
                        rule_name: "rule2"
                        inhibited_at: "2025-11-05T10:01:00Z"
                    count: 2
        '500':
          description: Internal server error (e.g., state manager failure)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Failed to retrieve inhibition status: Redis connection failed"

  /api/v2/inhibition/check:
    post:
      tags:
        - inhibition
      summary: Check if an alert would be inhibited
      description: |
        Checks if the provided alert would be inhibited by any currently firing alerts.

        This endpoint evaluates all inhibition rules against the provided alert
        and returns whether it would be inhibited, along with details about
        the inhibitor and matching rule.

        **Performance**: <3ms p99 (typical: 6-9µs)

        **Use Cases**:
        - Testing: Verify inhibition rules work as expected
        - Debugging: "Would this alert be inhibited?"
        - Integration: Pre-check before sending alerts

        **Note**: This is a dry-run check - it does not modify any state.

      operationId: checkAlertInhibition
      requestBody:
        required: true
        description: Alert to check for inhibition
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InhibitionCheckRequest'
            examples:
              simple:
                summary: Simple alert check
                value:
                  alert:
                    labels:
                      alertname: "InstanceDown"
                      node: "node1"
                      cluster: "prod"
                    annotations:
                      summary: "Instance down on node1"
                    status: "firing"
                    fingerprint: "abc123"
                    starts_at: "2025-11-05T10:00:00Z"
              complex:
                summary: Alert with many labels
                value:
                  alert:
                    labels:
                      alertname: "HighMemoryUsage"
                      node: "worker-1"
                      cluster: "prod"
                      datacenter: "us-east-1"
                      severity: "warning"
                      team: "platform"
                    annotations:
                      summary: "Memory usage above 90%"
                      description: "Memory usage on worker-1 is 92%"
                      runbook_url: "https://runbooks.example.com/memory"
                    status: "firing"
                    fingerprint: "xyz789"
                    starts_at: "2025-11-05T10:05:00Z"

      responses:
        '200':
          description: Successfully checked alert inhibition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InhibitionCheckResponse'
              examples:
                not_inhibited:
                  summary: Alert is NOT inhibited
                  value:
                    alert:
                      labels:
                        alertname: "InstanceDown"
                        node: "node1"
                      status: "firing"
                      fingerprint: "abc123"
                    inhibited: false
                    latency_ms: 1
                inhibited:
                  summary: Alert IS inhibited
                  value:
                    alert:
                      labels:
                        alertname: "InstanceDown"
                        node: "node1"
                        cluster: "prod"
                      status: "firing"
                      fingerprint: "abc123"
                    inhibited: true
                    inhibited_by:
                      labels:
                        alertname: "NodeDown"
                        node: "node1"
                        cluster: "prod"
                        severity: "critical"
                      status: "firing"
                      fingerprint: "def456"
                    rule:
                      name: "node-down-inhibits-instance-down"
                      source_match:
                        alertname: "NodeDown"
                        severity: "critical"
                      target_match:
                        alertname: "InstanceDown"
                      equal: ["node", "cluster"]
                    latency_ms: 2

        '400':
          description: Bad request (invalid JSON or missing required fields)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_json:
                  summary: Invalid JSON
                  value:
                    error: "Invalid request body"
                missing_alert:
                  summary: Missing alert field
                  value:
                    error: "Alert is required"

        '500':
          description: Internal server error (e.g., matcher failure)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Inhibition check failed: cache unavailable"

components:
  schemas:
    InhibitionRule:
      type: object
      description: Inhibition rule configuration
      required:
        - name
      properties:
        name:
          type: string
          description: Unique name for this inhibition rule
          example: "node-down-inhibits-instance-down"
        source_match:
          type: object
          description: Exact label matching for source alert (inhibitor)
          additionalProperties:
            type: string
          example:
            alertname: "NodeDown"
            severity: "critical"
        source_match_re:
          type: object
          description: Regex label matching for source alert
          additionalProperties:
            type: string
          example:
            severity: "critical|warning"
        target_match:
          type: object
          description: Exact label matching for target alert (to be inhibited)
          additionalProperties:
            type: string
          example:
            alertname: "InstanceDown"
        target_match_re:
          type: object
          description: Regex label matching for target alert
          additionalProperties:
            type: string
          example:
            alertname: ".*Down"
        equal:
          type: array
          description: Labels that must have the same value in both source and target
          items:
            type: string
          example: ["node", "cluster"]

    InhibitionRulesResponse:
      type: object
      description: Response for GET /api/v2/inhibition/rules
      required:
        - rules
        - count
      properties:
        rules:
          type: array
          description: List of all loaded inhibition rules
          items:
            $ref: '#/components/schemas/InhibitionRule'
        count:
          type: integer
          description: Total number of rules
          example: 1

    InhibitionState:
      type: object
      description: Active inhibition relationship
      required:
        - target_fingerprint
        - source_fingerprint
        - rule_name
        - inhibited_at
      properties:
        target_fingerprint:
          type: string
          description: Fingerprint of the inhibited alert
          example: "abc123"
        source_fingerprint:
          type: string
          description: Fingerprint of the source alert (inhibitor)
          example: "def456"
        rule_name:
          type: string
          description: Name of the rule that caused this inhibition
          example: "node-down-inhibits-instance-down"
        inhibited_at:
          type: string
          format: date-time
          description: When the inhibition relationship was established
          example: "2025-11-05T10:00:00Z"
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: When this inhibition expires (null = lasts until source resolves)
          example: "2025-11-05T10:05:00Z"

    InhibitionStatusResponse:
      type: object
      description: Response for GET /api/v2/inhibition/status
      required:
        - active
        - count
      properties:
        active:
          type: array
          description: List of all active inhibition relationships
          items:
            $ref: '#/components/schemas/InhibitionState'
        count:
          type: integer
          description: Total number of active inhibitions
          example: 1

    Alert:
      type: object
      description: Alert object (Alertmanager-compatible)
      required:
        - labels
        - status
        - fingerprint
      properties:
        labels:
          type: object
          description: Alert labels
          additionalProperties:
            type: string
          example:
            alertname: "InstanceDown"
            node: "node1"
            severity: "critical"
        annotations:
          type: object
          description: Alert annotations
          additionalProperties:
            type: string
          example:
            summary: "Instance down on node1"
            description: "HTTP endpoint unreachable"
        status:
          type: string
          enum: [firing, resolved]
          description: Alert status
          example: "firing"
        fingerprint:
          type: string
          description: Unique fingerprint for this alert
          example: "abc123"
        starts_at:
          type: string
          format: date-time
          description: When the alert started firing
          example: "2025-11-05T10:00:00Z"
        ends_at:
          type: string
          format: date-time
          nullable: true
          description: When the alert resolved (null if still firing)
          example: "2025-11-05T10:05:00Z"

    InhibitionCheckRequest:
      type: object
      description: Request body for POST /api/v2/inhibition/check
      required:
        - alert
      properties:
        alert:
          $ref: '#/components/schemas/Alert'

    InhibitionCheckResponse:
      type: object
      description: Response for POST /api/v2/inhibition/check
      required:
        - alert
        - inhibited
        - latency_ms
      properties:
        alert:
          $ref: '#/components/schemas/Alert'
        inhibited:
          type: boolean
          description: Whether the alert is inhibited
          example: true
        inhibited_by:
          $ref: '#/components/schemas/Alert'
          nullable: true
          description: The source alert causing the inhibition (null if not inhibited)
        rule:
          $ref: '#/components/schemas/InhibitionRule'
          nullable: true
          description: The rule that matched (null if not inhibited)
        latency_ms:
          type: integer
          format: int64
          description: Latency of the inhibition check in milliseconds
          example: 2

    ErrorResponse:
      type: object
      description: Error response
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
          example: "Failed to retrieve inhibition status"
