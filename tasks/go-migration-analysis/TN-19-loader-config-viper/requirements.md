# TN-19: Loader конфигурации (viper)

## Обоснование задачи
- Необходимо централизованно и предсказуемо загружать конфигурацию сервиса Go.
- Требуется единый источник правды для настроек: сервер, БД, Redis, LLM, логи, кэш, локи, приложение.
- Нужно обеспечить приоритеты загрузки: defaults < файл (yaml) < переменные окружения < флаги CLI.
- Конфигурация должна валидироваться и быть удобной для тестирования и деплоя (12-factor, конфигурация через env).

## Пользовательский сценарий
1. Оператор запускает бинарник сервиса:
   - без параметров — используются defaults + опционально `config.yaml` в рабочей директории + env-override;
   - с `-config /path/to/config.yaml` — значения из файла с перекрытием env;
   - с `CONFIG_FILE=/path/to/config.yaml` — аналогично флагу, если флаг не указан.
2. Приложение стартует HTTP сервер с таймаутами из конфигурации.
3. Приложение инициализирует пул PostgreSQL, используя настройки из конфигурации.
4. При невалидной конфигурации — процесс завершается с понятной ошибкой и exit code != 0 (кроме миграций — уже покрыто в TN-14/15).

## Требования и ограничения
- Использовать `spf13/viper` для:
  - defaults;
  - чтения YAML файла;
  - автоматического биндинга переменных окружения (replacer `.` -> `_`);
  - unmarshalling в типизированную структуру `Config`.
- Конфигурационные структуры уже определены в `go-app/internal/config/config.go` — их использовать как источник правды.
- Совместимость:
  - Значения из `go-app/config.yaml` должны корректно маппиться в структуры.
  - Переменные окружения вида `SERVER_PORT`, `DATABASE_HOST` и т.п. должны override-ить значения из файла.
- Интеграция в рантайм:
  - `cmd/server/main.go` должен загружать конфигурацию через `config.LoadConfig(...)`.
  - Параметры сервера (порт, таймауты, graceful timeout) — из `cfg.Server`.
  - Параметры БД — из `cfg.Database`, с маппингом в `postgres.PostgresConfig` (без изменения поведения пула).
- Ошибки:
  - Отсутствие файла конфигурации — не ошибка (используем defaults+env).
  - Ошибка синтаксиса YAML или невалидные значения — ошибка старта.
- Тестирование:
  - Unit-тесты для пакета `internal/config` (defaults, file load, env override).
  - Мелкий smoke-тест для `cmd/server`: как минимум успешная инициализация с defaults (можно оставить на интеграционные, если есть сложности).
- 12-factor:
  - Никаких хардкодов чувствительных значений в коде.
  - Все значения могут быть переопределены через env.
- Не входящее в TN-19 (будет в TN-20):
  - Полноценная настройка structured logging через конфиг (уровни/вывод/ротация). В TN-19 достаточно прочитать `log.level` и применить к slog при старте.

## Внешние зависимости
- `github.com/spf13/viper` — уже присутствует (используется в `internal/config`).
- Файл `go-app/config.yaml` — базовые значения по умолчанию.

## Критерии приемки (DoD)
- Загруженная конфигурация корректно влияет на:
  - порт и таймауты HTTP сервера;
  - параметры подключения к PostgreSQL (host, port, db, user, password, sslmode, pool limits и таймауты, где уместно);
- Поддерживаются источники в порядке приоритета:
  1) defaults в коде;
  2) YAML файл (если указан через `-config` или переменную `CONFIG_FILE`, либо найден как `./config.yaml`);
  3) переменные окружения (высший приоритет).
- В `cmd/server/main.go` добавлен флаг `-config`; учтена переменная `CONFIG_FILE`.
- Добавлены тесты `internal/config/config_test.go`, покрывающие:
  - загрузку defaults без файла/окружения;
  - загрузку из временного YAML файла;
  - override значений через env.
- Описаны `requirements.md`, `design.md`, `tasks.md` в `tasks/go-migration-analysis/TN-19-loader-config-viper/`.
