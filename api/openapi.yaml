openapi: 3.0.3
info:
  title: Alert History Webhook API
  version: 1.0.0
  description: |
    Universal webhook endpoint for receiving alerts from Alertmanager and other sources.
    
    ## Features
    - Auto-detection of webhook formats (Alertmanager, Generic)
    - Multiple authentication methods (API Key, HMAC signature)
    - Rate limiting (per-IP and global)
    - Comprehensive input validation
    - OWASP Top 10 compliant
    
    ## Phase
    TN-061: POST /webhook - Universal Webhook Endpoint
    
  contact:
    name: Alert History Team
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://alerts.example.com
    description: Production server
  - url: https://staging-alerts.example.com
    description: Staging server
  - url: http://localhost:8080
    description: Local development

tags:
  - name: webhook
    description: Webhook endpoint operations
  - name: health
    description: Health check operations

paths:
  /webhook:
    post:
      tags:
        - webhook
      summary: Receive webhook alerts
      description: |
        Universal endpoint that accepts webhooks in multiple formats.
        Automatically detects format (Alertmanager, Generic) and processes alerts.
        
        ## Authentication
        Supports two methods:
        - API Key: Pass in `X-API-Key` header
        - HMAC Signature: Pass in `X-Signature` header
        
        ## Rate Limiting
        - Per-IP: 100 requests per minute
        - Global: 10,000 requests per minute
        
        ## Request Size
        - Maximum: 10MB
        - Maximum alerts per request: 1000
      operationId: postWebhook
      security:
        - ApiKeyAuth: []
        - HmacAuth: []
        - {}  # Allow unauthenticated if auth is disabled
      parameters:
        - name: X-Request-ID
          in: header
          description: Optional request ID for tracking
          required: false
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AlertmanagerWebhook'
            examples:
              alertmanager:
                summary: Alertmanager webhook
                value:
                  receiver: "team-alerts"
                  status: "firing"
                  alerts:
                    - status: "firing"
                      labels:
                        alertname: "HighCPU"
                        severity: "critical"
                        instance: "server1"
                      annotations:
                        summary: "High CPU usage on server1"
                        description: "CPU usage is above 90%"
                      startsAt: "2025-11-15T10:00:00Z"
                  groupLabels:
                    alertname: "HighCPU"
                  commonLabels:
                    severity: "critical"
                  commonAnnotations: {}
                  externalURL: "https://alertmanager.example.com"
              generic:
                summary: Generic webhook
                value:
                  alerts:
                    - status: "firing"
                      labels:
                        alertname: "CustomAlert"
                        severity: "warning"
      responses:
        '200':
          description: All alerts processed successfully
          headers:
            X-Request-ID:
              description: Request ID for tracking
              schema:
                type: string
                format: uuid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'
              example:
                status: "success"
                message: "All alerts processed successfully"
                request_id: "550e8400-e29b-41d4-a716-446655440000"
                alerts_received: 1
                alerts_processed: 1
                alerts_failed: 0
        '207':
          description: Partial success (some alerts failed)
          headers:
            X-Request-ID:
              schema:
                type: string
                format: uuid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'
              example:
                status: "partial_success"
                message: "Processed 8 out of 10 alerts"
                request_id: "550e8400-e29b-41d4-a716-446655440000"
                alerts_received: 10
                alerts_processed: 8
                alerts_failed: 2
                errors:
                  - alert_index: 3
                    error: "Invalid label key: alert-name"
                  - alert_index: 7
                    error: "Status validation failed"
        '400':
          description: Bad request (invalid payload)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: "error"
                message: "Invalid request payload"
                request_id: "550e8400-e29b-41d4-a716-446655440000"
                error_type: "validation_error"
                details: "JSON parsing failed: invalid character"
        '401':
          description: Authentication required or failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: "error"
                message: "Authentication required"
                request_id: "550e8400-e29b-41d4-a716-446655440000"
                error_type: "auth_error"
        '413':
          description: Payload too large
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: "error"
                message: "Request payload too large"
                request_id: "550e8400-e29b-41d4-a716-446655440000"
                error_type: "size_limit_exceeded"
                details: "Maximum size: 10MB"
        '429':
          description: Rate limit exceeded
          headers:
            Retry-After:
              description: Seconds until rate limit resets
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: "error"
                message: "Rate limit exceeded"
                request_id: "550e8400-e29b-41d4-a716-446655440000"
                error_type: "rate_limit_exceeded"
                details: "Try again in 60 seconds"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: "error"
                message: "Internal server error"
                request_id: "550e8400-e29b-41d4-a716-446655440000"
                error_type: "internal_error"
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: "error"
                message: "Service temporarily unavailable"
                request_id: "550e8400-e29b-41d4-a716-446655440000"
                error_type: "service_unavailable"

  /healthz:
    get:
      tags:
        - health
      summary: Health check
      description: Returns the health status of the service
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  timestamp:
                    type: string
                    format: date-time
              example:
                status: "healthy"
                timestamp: "2025-11-15T12:00:00Z"
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "unhealthy"
                  reason:
                    type: string
                  timestamp:
                    type: string
                    format: date-time

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key authentication
    HmacAuth:
      type: apiKey
      in: header
      name: X-Signature
      description: HMAC SHA-256 signature authentication (format: sha256=<hex>)

  schemas:
    AlertmanagerWebhook:
      type: object
      required:
        - alerts
      properties:
        receiver:
          type: string
          description: Receiver name (Alertmanager specific)
          example: "team-alerts"
        status:
          type: string
          description: Overall status (Alertmanager specific)
          enum: [firing, resolved]
          example: "firing"
        alerts:
          type: array
          description: List of alerts
          minItems: 1
          maxItems: 1000
          items:
            $ref: '#/components/schemas/Alert'
        groupLabels:
          type: object
          description: Labels used for grouping (Alertmanager specific)
          additionalProperties:
            type: string
        commonLabels:
          type: object
          description: Labels common to all alerts (Alertmanager specific)
          additionalProperties:
            type: string
        commonAnnotations:
          type: object
          description: Annotations common to all alerts (Alertmanager specific)
          additionalProperties:
            type: string
        externalURL:
          type: string
          format: uri
          description: External URL of Alertmanager
          example: "https://alertmanager.example.com"
        version:
          type: string
          description: Alertmanager version
          example: "4"
        groupKey:
          type: string
          description: Group key
        truncatedAlerts:
          type: integer
          description: Number of truncated alerts

    Alert:
      type: object
      required:
        - status
        - labels
      properties:
        status:
          type: string
          description: Alert status
          enum: [firing, resolved]
          example: "firing"
        labels:
          type: object
          description: Alert labels
          additionalProperties:
            type: string
            maxLength: 1024
          example:
            alertname: "HighCPU"
            severity: "critical"
            instance: "server1"
        annotations:
          type: object
          description: Alert annotations
          additionalProperties:
            type: string
            maxLength: 4096
          example:
            summary: "High CPU usage"
            description: "CPU usage is above 90%"
            runbook_url: "https://docs.example.com/runbooks/high-cpu"
        startsAt:
          type: string
          format: date-time
          description: Alert start time
          example: "2025-11-15T10:00:00Z"
        endsAt:
          type: string
          format: date-time
          description: Alert end time (for resolved alerts)
          example: "2025-11-15T11:00:00Z"
        generatorURL:
          type: string
          format: uri
          description: URL to the alert generator
          example: "https://prometheus.example.com/graph?g0.expr=..."
        fingerprint:
          type: string
          description: Alert fingerprint (SHA-256 hash)
          example: "a1b2c3d4e5f6"

    WebhookResponse:
      type: object
      required:
        - status
        - message
        - request_id
        - alerts_received
        - alerts_processed
        - alerts_failed
      properties:
        status:
          type: string
          enum: [success, partial_success, error]
          description: Overall status
          example: "success"
        message:
          type: string
          description: Human-readable message
          example: "All alerts processed successfully"
        request_id:
          type: string
          format: uuid
          description: Request ID for tracking
          example: "550e8400-e29b-41d4-a716-446655440000"
        alerts_received:
          type: integer
          description: Number of alerts received
          example: 10
        alerts_processed:
          type: integer
          description: Number of alerts processed successfully
          example: 10
        alerts_failed:
          type: integer
          description: Number of alerts that failed processing
          example: 0
        errors:
          type: array
          description: List of errors (for partial success or errors)
          items:
            type: object
            properties:
              alert_index:
                type: integer
                description: Index of the failed alert (0-based)
              error:
                type: string
                description: Error message

    ErrorResponse:
      type: object
      required:
        - status
        - message
        - request_id
      properties:
        status:
          type: string
          enum: [error]
          example: "error"
        message:
          type: string
          description: Error message
          example: "Invalid request payload"
        request_id:
          type: string
          format: uuid
          description: Request ID for tracking
          example: "550e8400-e29b-41d4-a716-446655440000"
        error_type:
          type: string
          description: Error type
          enum:
            - validation_error
            - auth_error
            - rate_limit_exceeded
            - size_limit_exceeded
            - timeout_error
            - internal_error
            - service_unavailable
          example: "validation_error"
        details:
          type: string
          description: Additional error details
          example: "JSON parsing failed"

