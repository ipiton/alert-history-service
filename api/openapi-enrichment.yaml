openapi: 3.0.3
info:
  title: Alert History - Enrichment Mode API
  description: |
    # Enrichment Mode Management API

    This API provides endpoints to manage the enrichment mode for the Alert History service.

    ## Features
    - Get current enrichment mode
    - Set enrichment mode
    - Redis persistence with in-memory fallback
    - Environment variable override support
    - Ultra-fast performance (2ns cache hit latency)

    ## Enrichment Modes
    - **enriched**: Full AI-powered enrichment (default)
    - **transparent**: Pass-through mode (no enrichment)
    - **transparent_with_recommendations**: Pass-through with AI recommendations

    ## Performance
    - **Latency p50**: < 100ns (actual: 2ns)
    - **Throughput**: > 100K req/s (actual: 32M req/s)
    - **Concurrent**: 10K+ goroutines safe

    ## Documentation
    - [Requirements](../tasks/TN-74-enrichment-mode-get/requirements.md)
    - [Architecture](../tasks/TN-74-enrichment-mode-get/design.md)
    - [API Guide](../tasks/TN-74-enrichment-mode-get/API_GUIDE.md)
    - [Performance Report](../tasks/TN-74-enrichment-mode-get/PERFORMANCE_REPORT.md)

  version: 1.0.0
  contact:
    name: Alert History Team
    url: https://github.com/vitaliisemenov/alert-history
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://alert-history.example.com
    description: Production server
  - url: https://alert-history-staging.example.com
    description: Staging server

tags:
  - name: enrichment
    description: Enrichment mode management endpoints
    externalDocs:
      description: API Guide
      url: https://github.com/vitaliisemenov/alert-history/blob/main/tasks/TN-74-enrichment-mode-get/API_GUIDE.md

paths:
  /enrichment/mode:
    get:
      summary: Get current enrichment mode
      description: |
        Returns the current enrichment mode and its source (redis/memory/env/default).

        This endpoint is ultra-fast with 2ns average latency and supports 32M req/s throughput.

        ## Source Priority
        1. **redis**: Mode stored in Redis (highest priority)
        2. **memory**: In-memory cache (when Redis unavailable)
        3. **env**: Environment variable `ENRICHMENT_MODE`
        4. **default**: Default mode (enriched)

        ## Performance
        - **Cache Hit**: ~2ns latency
        - **Redis Fallback**: <2ms latency
        - **Zero Allocations**: No heap allocations in hot path

        ## Use Cases
        - Dashboard display of current mode
        - Monitoring/alerting systems
        - Health checks
        - Configuration validation

      operationId: getEnrichmentMode
      tags:
        - enrichment
      responses:
        '200':
          description: Current enrichment mode retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnrichmentModeResponse'
              examples:
                redis_source:
                  summary: Mode from Redis
                  value:
                    mode: enriched
                    source: redis
                env_source:
                  summary: Mode from environment variable
                  value:
                    mode: transparent
                    source: env
                default_source:
                  summary: Default mode
                  value:
                    mode: enriched
                    source: default
                memory_cache:
                  summary: In-memory cache (Redis down)
                  value:
                    mode: transparent_with_recommendations
                    source: memory
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Failed to get enrichment mode
      x-code-samples:
        - lang: curl
          source: |
            curl -X GET http://localhost:8080/enrichment/mode
        - lang: Go
          source: |
            resp, err := http.Get("http://localhost:8080/enrichment/mode")
            if err != nil {
                log.Fatal(err)
            }
            defer resp.Body.Close()

            var result EnrichmentModeResponse
            json.NewDecoder(resp.Body).Decode(&result)
            fmt.Printf("Mode: %s (source: %s)\n", result.Mode, result.Source)
        - lang: Python
          source: |
            import requests

            response = requests.get("http://localhost:8080/enrichment/mode")
            data = response.json()
            print(f"Mode: {data['mode']} (source: {data['source']})")
        - lang: JavaScript
          source: |
            const response = await fetch('http://localhost:8080/enrichment/mode');
            const data = await response.json();
            console.log(`Mode: ${data.mode} (source: ${data.source})`);

    post:
      summary: Set enrichment mode
      description: |
        Sets the enrichment mode and persists it to Redis.

        The new mode is stored in Redis and immediately reflected in the in-memory cache.
        This operation is atomic and thread-safe.

        ## Validation
        - Only valid modes are accepted (enriched/transparent/transparent_with_recommendations)
        - Invalid modes return 400 Bad Request
        - Case-sensitive validation

        ## Persistence
        - Mode is stored in Redis (survives restarts)
        - In-memory cache is updated immediately
        - Fallback to memory cache if Redis unavailable

        ## Performance
        - **Latency**: <10ms (including Redis write)
        - **Atomic**: Thread-safe mode switches
        - **Zero Downtime**: Service continues during mode change

        ## Use Cases
        - Manual mode switching (ops team)
        - Automated failover (monitoring)
        - Testing/debugging
        - Feature flags

      operationId: setEnrichmentMode
      tags:
        - enrichment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetEnrichmentModeRequest'
            examples:
              set_enriched:
                summary: Set to enriched mode
                value:
                  mode: enriched
              set_transparent:
                summary: Set to transparent mode
                value:
                  mode: transparent
              set_transparent_with_recommendations:
                summary: Set to transparent with recommendations
                value:
                  mode: transparent_with_recommendations
      responses:
        '200':
          description: Enrichment mode set successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnrichmentModeResponse'
              example:
                mode: transparent
                source: redis
        '400':
          description: Invalid request (invalid mode)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_mode:
                  summary: Invalid mode value
                  value:
                    error: "invalid enrichment mode: invalid"
                invalid_json:
                  summary: Invalid JSON
                  value:
                    error: "Invalid JSON"
                empty_mode:
                  summary: Empty mode
                  value:
                    error: "invalid enrichment mode: "
        '500':
          description: Internal server error (e.g., Redis connection failed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Failed to set enrichment mode
      x-code-samples:
        - lang: curl
          source: |
            curl -X POST http://localhost:8080/enrichment/mode \
              -H "Content-Type: application/json" \
              -d '{"mode":"transparent"}'
        - lang: Go
          source: |
            data := SetEnrichmentModeRequest{Mode: "transparent"}
            body, _ := json.Marshal(data)

            resp, err := http.Post(
                "http://localhost:8080/enrichment/mode",
                "application/json",
                bytes.NewBuffer(body),
            )
            if err != nil {
                log.Fatal(err)
            }
            defer resp.Body.Close()

            var result EnrichmentModeResponse
            json.NewDecoder(resp.Body).Decode(&result)
            fmt.Printf("Mode set to: %s\n", result.Mode)
        - lang: Python
          source: |
            import requests

            response = requests.post(
                "http://localhost:8080/enrichment/mode",
                json={"mode": "transparent"}
            )
            data = response.json()
            print(f"Mode set to: {data['mode']}")
        - lang: JavaScript
          source: |
            const response = await fetch('http://localhost:8080/enrichment/mode', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({mode: 'transparent'})
            });
            const data = await response.json();
            console.log(`Mode set to: ${data.mode}`);

components:
  schemas:
    EnrichmentModeResponse:
      type: object
      required:
        - mode
        - source
      properties:
        mode:
          type: string
          enum:
            - enriched
            - transparent
            - transparent_with_recommendations
          description: |
            Current enrichment mode.

            - **enriched**: Full AI-powered enrichment (default)
            - **transparent**: Pass-through mode (no enrichment)
            - **transparent_with_recommendations**: Pass-through with AI recommendations
          example: enriched
        source:
          type: string
          enum:
            - redis
            - memory
            - env
            - default
          description: |
            Source of the current mode (priority order: redis > env > default).

            - **redis**: Mode stored in Redis (highest priority, persists across restarts)
            - **memory**: In-memory cache (used when Redis is unavailable)
            - **env**: Environment variable `ENRICHMENT_MODE`
            - **default**: Default mode (enriched)
          example: redis
      example:
        mode: enriched
        source: redis

    SetEnrichmentModeRequest:
      type: object
      required:
        - mode
      properties:
        mode:
          type: string
          enum:
            - enriched
            - transparent
            - transparent_with_recommendations
          description: |
            The enrichment mode to set.

            **Valid modes**:
            - **enriched**: Full AI-powered enrichment (default)
            - **transparent**: Pass-through mode (no enrichment)
            - **transparent_with_recommendations**: Pass-through with AI recommendations

            **Note**: Case-sensitive, lowercase only.
          example: transparent
      example:
        mode: transparent

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Human-readable error message
          example: Failed to get enrichment mode
      example:
        error: Invalid enrichment mode

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Optional JWT authentication for production environments.

        Currently not enforced for internal APIs.

# Security (optional, not currently enforced)
# security:
#   - bearerAuth: []

x-readme:
  samples-languages:
    - curl
    - go
    - python
    - javascript
